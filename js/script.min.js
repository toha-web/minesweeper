const page=document.querySelector(".wrapper");page.addEventListener("click",(e=>{e.preventDefault()})),page.addEventListener("contextmenu",(e=>{e.preventDefault()}));let gameStatus,gameTime,t,lastRecord,cellCounter,recordsData={easy:[],normal:[],hard:[],suicide:[]};if(localStorage.recordsData)try{recordsData=JSON.parse(localStorage.getItem("recordsData"))}catch(e){console.warn(e)}const fieldBody=document.querySelector(".game-field-body"),scoreField=document.querySelector(".score"),timer=document.querySelector(".timer"),button=document.querySelector(".game-status button");function gameTimer(e){"start"===e?t=setInterval((()=>{gameTime+=1,timer.innerText=gameTime}),1e3):"pause"!==e&&"stop"!==e||clearInterval(t)}function start(){if(gameStatus=null,gameTime=0,timer.innerText=gameTime,button.innerText="Pause",button.disabled=!0,localStorage.level){let e=JSON.parse(localStorage.getItem("level"));createField(e.level,e.bombIndex)}else createField()}function startGame(){gameStatus="game",button.disabled=!1,gameTimer("start")}function finishGame(){gameStatus="finished",button.innerText="Start",gameTimer("stop")}button.addEventListener("click",(()=>{"game"===gameStatus?(gameTimer("pause"),button.innerText="Resume",gameStatus="paused"):"paused"===gameStatus?(gameTimer("start"),button.innerText="Pause",gameStatus="game"):"finished"===gameStatus&&(button.innerText="Pause",gameTime=0,timer.innerText=gameTime,start())})),start();const select=document.querySelector("select");function createField(e=10,t=7){fieldBody.replaceChildren();let a=[],n=[];const c=e,d=Math.round(e/1.5),r=c*d;cellCounter=r;const i=r/t;scoreField.innerText=i;for(let e=1;e<=c;e++){a[e]=[];for(let t=0;t<d;t++){const n=document.createElement("div");n.classList.add("cell","closed"),n.bombQty=0,n.counter=0,n.flagQty=0,n.addEventListener("click",(()=>{if(null===gameStatus)startGame();else if("paused"===gameStatus||"finished"===gameStatus)return;n.verified||n.dataset.checked||(n.mined?gameCheck(a):n.mined||roundCheck(a,n))})),n.addEventListener("contextmenu",(e=>{if(e.preventDefault(),null===gameStatus)startGame();else if("paused"===gameStatus||"finished"===gameStatus)return;if(!n.classList.contains("opened"))if(n.dataset.checked){if(n.dataset.checked){delete n.dataset.checked,cellCounter++;let e=scoreField.innerText;++e,scoreField.innerText=e}}else{n.dataset.checked=!0,cellCounter--;let e=scoreField.innerText;--e,scoreField.innerText=e,0===e&&0===cellCounter&&gameCheck(a)}})),n.addEventListener("dblclick",(()=>{"paused"!==gameStatus&&"finished"!==gameStatus&&0!==n.bombQty&&roundCheck(a,n,"dblclick")})),a[e][t]=n,fieldBody.append(n),fieldBody.style.width=27*c+"px",fieldBody.style.height=27*d+"px"}}n=miningField(a,i)}function miningField(e,t){let a=0,n=[];for(;a<t;){let t=Math.floor(Math.random()*(e.length-1)+1),c=Math.floor(Math.random()*e[1].length);e[t][c].mined||(e[t][c].mined=!0,n.push(e[t][c]),a++)}return n}function roundCheck(e,t,a=!1){if(t.counter++,a||!(t.counter>2)){"dblclick"===a&&(t.flagQty=0);e:for(let n=1;n<e.length;n++)for(let c=0;c<e[n].length;c++)if(e[n][c]===t){if(1!==n&&0!==c&&("open"===a?e[n-1][c-1].dataset.checked||e[n-1][c-1].verified||(e[n-1][c-1].mined?gameCheck(e):e[n-1][c-1].mined||roundCheck(e,e[n-1][c-1])):"dblclick"===a?e[n-1][c-1].dataset.checked&&t.flagQty++:t.verified?e[n-1][c-1].dataset.checked||(t=e[n-1][c-1]).verified||roundCheck(e,t):e[n-1][c-1].mined&&t.bombQty++),0!==c&&("open"===a?e[n][c-1].dataset.checked||e[n][c-1].verified||(e[n][c-1].mined?gameCheck(e):e[n][c-1].mined||roundCheck(e,e[n][c-1])):"dblclick"===a?e[n][c-1].dataset.checked&&t.flagQty++:t.verified?e[n][c-1].dataset.checked||(t=e[n][c-1]).verified||roundCheck(e,t):e[n][c-1].mined&&t.bombQty++),n!==e.length-1&&0!==c&&("open"===a?e[n+1][c-1].dataset.checked||e[n+1][c-1].verified||(e[n+1][c-1].mined?gameCheck(e):e[n+1][c-1].mined||roundCheck(e,e[n+1][c-1])):"dblclick"===a?e[n+1][c-1].dataset.checked&&t.flagQty++:t.verified?e[n+1][c-1].dataset.checked||(t=e[n+1][c-1]).verified||roundCheck(e,t):e[n+1][c-1].mined&&t.bombQty++),1!==n&&("open"===a?e[n-1][c].dataset.checked||e[n-1][c].verified||(e[n-1][c].mined?gameCheck(e):e[n-1][c].mined||roundCheck(e,e[n-1][c])):"dblclick"===a?e[n-1][c].dataset.checked&&t.flagQty++:t.verified?e[n-1][c].dataset.checked||(t=e[n-1][c]).verified||roundCheck(e,t):e[n-1][c].mined&&t.bombQty++),n!==e.length-1&&("open"===a?e[n+1][c].dataset.checked||e[n+1][c].verified||(e[n+1][c].mined?gameCheck(e):e[n+1][c].mined||roundCheck(e,e[n+1][c])):"dblclick"===a?e[n+1][c].dataset.checked&&t.flagQty++:t.verified?e[n+1][c].dataset.checked||(t=e[n+1][c]).verified||roundCheck(e,t):e[n+1][c].mined&&t.bombQty++),1!==n&&c!==e[n].length-1&&("open"===a?e[n-1][c+1].dataset.checked||e[n-1][c+1].verified||(e[n-1][c+1].mined?gameCheck(e):e[n-1][c+1].mined||roundCheck(e,e[n-1][c+1])):"dblclick"===a?e[n-1][c+1].dataset.checked&&t.flagQty++:t.verified?e[n-1][c+1].dataset.checked||(t=e[n-1][c+1]).verified||roundCheck(e,t):e[n-1][c+1].mined&&t.bombQty++),c!==e[n].length-1&&("open"===a?e[n][c+1].dataset.checked||e[n][c+1].verified||(e[n][c+1].mined?gameCheck(e):e[n][c+1].mined||roundCheck(e,e[n][c+1])):"dblclick"===a?e[n][c+1].dataset.checked&&t.flagQty++:t.verified?e[n][c+1].dataset.checked||(t=e[n][c+1]).verified||roundCheck(e,t):e[n][c+1].mined&&t.bombQty++),n!==e.length-1&&c!==e[n].length-1&&("open"===a?e[n+1][c+1].dataset.checked||e[n+1][c+1].verified||(e[n+1][c+1].mined?gameCheck(e):e[n+1][c+1].mined||roundCheck(e,e[n+1][c+1])):"dblclick"===a?e[n+1][c+1].dataset.checked&&t.flagQty++:t.verified?e[n+1][c+1].dataset.checked||(t=e[n+1][c+1]).verified||roundCheck(e,t):e[n+1][c+1].mined&&t.bombQty++),"dblclick"===a){if(t.flagQty!==t.bombQty)return;roundCheck(e,t,"open")}t.classList.remove("closed"),t.classList.add("opened"),t.verified||cellCounter--,t.verified=!0,0!==t.bombQty&&(t.innerText=t.bombQty),0===t.bombQty&&roundCheck(e,t);break e}0===cellCounter&&0==scoreField.innerText&&gameCheck(e),console.log(cellCounter)}}function gameCheck(e){let t=!0;for(let a=1;a<=e.length-1;a++)for(let n=0;n<=e[a].length-1;n++)e[a][n].dataset.checked&&!e[a][n].mined?(e[a][n].classList.add("wrong"),t=!1):e[a][n].mined&&!e[a][n].dataset.checked&&(e[a][n].classList.remove("closed"),e[a][n].classList.add("opened"),e[a][n].dataset.mined=!0,t=!1);t?victory():fail(),finishGame()}function victory(){const e=document.querySelector(".finish-victory");e.style.height=parseInt(fieldBody.style.height)+110+"px",e.style.width=fieldBody.style.width,e.style.display="flex",e.addEventListener("click",(()=>{e.style.display="none"})),checkRecords()}function fail(){const e=document.querySelector(".finish-fail");e.style.height=parseInt(fieldBody.style.height)+110+"px",e.style.width=fieldBody.style.width,e.style.display="flex",e.addEventListener("click",(()=>{e.style.display="none"}))}select.addEventListener("change",(()=>{let e,t;switch(finishGame(),select.value){case"junior":e=10,t=7;break;case"middle":e=15,t=6;break;case"senior":e=20,t=5;break;case"master":e=30,t=4}createField(e,t);let a={level:e,bombIndex:t};localStorage.setItem("level",JSON.stringify(a)),start()}));const recordsIcon=document.querySelector(".records"),infoSpan=document.createElement("span");function checkRecords(){let e;if(localStorage.level){switch(JSON.parse(localStorage.getItem("level")).level){case 10:e="easy";break;case 15:e="normal";break;case 20:e="hard";break;case 30:e="suicide";break;default:e="undefined"}}else e="easy";recordsData&&recordsData[e].length>2?recordsData[e].at(-1).time>gameTime&&saveRecords(e):saveRecords(e)}async function saveRecords(e){let t;t=await getUserName(),localStorage.setItem("user",JSON.stringify(t)),lastRecord={name:t,time:gameTime},recordsData[e].push({name:t,time:gameTime}),recordsData[e].sort(((e,t)=>e.time-t.time)),recordsData[e]=recordsData[e].slice(0,3),localStorage.setItem("recordsData",JSON.stringify(recordsData))}async function getUserName(){const e=document.createElement("div");e.className="user-name";const t=document.createElement("label");t.innerText="Your name is worthy of being in records!";const a=document.createElement("div"),n=document.createElement("input");let c;if(n.autofocus=!0,n.placeholder="Name",localStorage.user)try{c=JSON.parse(localStorage.getItem("user"))}catch(e){console.warn(e)}c&&(n.value=c);const d=document.createElement("button");return d.innerText="Ok",a.append(n,d),e.append(t,a),page.append(e),new Promise((t=>{d.addEventListener("click",(()=>{e.remove(),t(n.value||"Anonym")}))}))}recordsIcon.addEventListener("click",(()=>{const e=document.querySelector(".records-table");e.style.display="block";document.querySelector(".close-table span").addEventListener("click",(()=>{e.style.display="none"}));const t=document.querySelector(".records-table tbody");t.replaceChildren(),infoSpan.innerText="Start playing to get into the table!",infoSpan.remove(),localStorage.recordsData?Object.entries(recordsData).forEach((e=>{let a;a=e[0][0].toUpperCase()+e[0].slice(1),e[1].forEach((e=>{const n=document.createElement("tr"),c=document.createElement("td");c.innerText=`${a}`;const d=document.createElement("td");d.innerText=`${e.name}`;const r=document.createElement("td");let i=e.time,o=Math.floor(i/60);r.innerText=`${o}:${(i%60).toString().padStart(2,"0")}`,n.append(c,d,r),t.append(n)}))})):e.append(infoSpan)}));